<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom model objects &mdash; AstroPhot 0.1.dev1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />

  
    <link rel="shortcut icon" href="_static/AP_logo_favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=6aee1ebc"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced PSF modeling" href="AdvancedPSFModels.html" />
    <link rel="prev" title="Joint Modelling" href="JointModels.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            AstroPhot
          </a>
              <div class="version">
                0.1.dev1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="GettingStarted.html">Getting Started with AstroPhot</a></li>
<li class="toctree-l2"><a class="reference internal" href="GroupModels.html">Group Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="FittingMethods.html">Fitting Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="ModelZoo.html">Model Zoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="JointModels.html">Joint Modelling</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Custom model objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#AstroPhot-model-hierarchy">AstroPhot model hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Remaking-the-Sersic-model">Remaking the Sersic model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Adding-an-initialize-method">Adding an initialize method</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Models-from-scratch">Models from scratch</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="AdvancedPSFModels.html">Advanced PSF modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="ConstrainedModels.html">Constrained Models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="coordinates.html">Coordinates</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="citation.html">Citing AstroPhot</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">astrophot</a></li>
<li class="toctree-l1"><a class="reference internal" href="configfile_interface.html">Configuration File Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">LICENSE</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AstroPhot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Custom model objects</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/CustomModels.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Custom-model-objects">
<h1>Custom model objects<a class="headerlink" href="#Custom-model-objects" title="Link to this heading"></a></h1>
<p>Here we will go over some of the core functionality of AstroPhot models so that you can make your own custom models with arbitrary behavior. This is an advanced tutorial and likely not needed for most users. However, the flexibility of AstroPhot can be a real lifesaver for some niche applications! If you get stuck trying to make your own models, please contact Connor Stone (see GitHub), he can help you get the model working and maybe even help add it to the core AstroPhot model list!</p>
<section id="AstroPhot-model-hierarchy">
<h2>AstroPhot model hierarchy<a class="headerlink" href="#AstroPhot-model-hierarchy" title="Link to this heading"></a></h2>
<p>AstroPhot models are very much object oriented and inheritence driven. Every AstroPhot model inherits from <code class="docutils literal notranslate"><span class="pre">AstroPhot_Model</span></code> and so if you wish to make something truly original then this is where you would need to start. However, it is almost certain that is the wrong way to go. Further down the hierarchy is the <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> object, this is what you will likely use to construct a custom model as it represents a single “unit” in the astronomical image. Spline, Sersic, Exponential,
Gaussian, PSF, Sky, etc. all of these inherit from <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> so likely that’s what you will want. At its core, a <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> object defines a center location for the model, but it doesn’t know anything else yet. At the same level as <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> is <code class="docutils literal notranslate"><span class="pre">Group_Model</span></code> which represents a collection of model objects (typically but not always <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> objects). A <code class="docutils literal notranslate"><span class="pre">Group_Model</span></code> is how you construct more complex models by composing several simpler models. It’s
unlikely you’ll need to inherit from <code class="docutils literal notranslate"><span class="pre">Group_Model</span></code> so we won’t discuss this any further (contact the developers if you’re thinking about that).</p>
<p>Inheriting from <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> are a few general classes which make it easier to build typical cases. There is the <code class="docutils literal notranslate"><span class="pre">Galaxy_Model</span></code> which adds a position angle and axis ratio to the model; also <code class="docutils literal notranslate"><span class="pre">Star_Model</span></code> which simply enforces no psf convolution on the object since that will be handled internally for anything star like; <code class="docutils literal notranslate"><span class="pre">Sky_Model</span></code> should be used for anything low resolution defined over the entire image, in this model psf convolution and integration are turned off since they shouldn’t
be needed. Based on these low level classes, you can “jump in” where it makes sense to define your model. Of course, you can take any AstroPhot model as a starting point and modify it to suit a given task, however we will not list all models here. See the documentation for a more complete list.</p>
</section>
<section id="Remaking-the-Sersic-model">
<h2>Remaking the Sersic model<a class="headerlink" href="#Remaking-the-Sersic-model" title="Link to this heading"></a></h2>
<p>Here we will remake the sersic model in AstroPhot to demonstrate how new models can be created</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import astrophot as ap
import torch
from astropy.io import fits
import numpy as np
import matplotlib.pyplot as plt
ap.AP_config.set_logging_output(stdout = True, filename = None) # see GettingStarted tutorial for what this does
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class My_Sersic(ap.models.Galaxy_Model):
    &quot;&quot;&quot;Let&#39;s make a sersic model!
    &quot;&quot;&quot;

    model_type = f&quot;mysersic {ap.models.Galaxy_Model.model_type}&quot; # here we give a name to the model, the convention is to lead with a new identifier then include the name of the inheritance model
    parameter_specs = {
        &quot;my_n&quot;: {&quot;limits&quot;: (0.36,8)}, # our sersic index will have some default limits so it doesn&#39;t produce weird results
        &quot;my_Re&quot;: {&quot;limits&quot;: (0,None)}, # our effective radius must be positive, otherwise it is fair game
        &quot;my_Ie&quot;: {}, # our effective surface density could be any real number
    }
    _parameter_order = ap.models.Galaxy_Model._parameter_order + (&quot;my_n&quot;, &quot;my_Re&quot;, &quot;my_Ie&quot;) # we have to tell AstroPhot what order to access these parameters, this is used in several underlying methods

    def radial_model(self, R, image = None, parameters = None): # by default a Galaxy_Model object will call radial_model to determine the flux at each pixel
        bn = ap.utils.conversions.functions.sersic_n_to_b(parameters[&quot;my_n&quot;].value) # AstroPhot has a number of useful util functions, though you are welcome to use your own
        return parameters[&quot;my_Ie&quot;].value * (image.pixel_area) * torch.exp(-bn * ((R / parameters[&quot;my_Re&quot;].value)**(1. / parameters[&quot;my_n&quot;].value) - 1)) # this is simply the classic sersic profile. more details later.
</pre></div>
</div>
</div>
<p>Now lets try optimizing our sersic model on some data. We’ll use the same galaxy from the GettingStarted tutorial. The results should be about the same!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>hdu = fits.open(&quot;https://www.legacysurvey.org/viewer/fits-cutout?ra=36.3684&amp;dec=-25.6389&amp;size=700&amp;layer=ls-dr9&amp;pixscale=0.262&amp;bands=r&quot;)
target_data = np.array(hdu[0].data, dtype = np.float64)

# Create a target object with specified pixelscale and zeropoint
target = ap.image.Target_Image(
    data = target_data,
    pixelscale = 0.262,
    zeropoint = 22.5,
    variance = np.ones(target_data.shape)/1e3,
)

# The default AstroPhot target plotting method uses log scaling in bright areas and histogram scaling in faint areas
fig, ax = plt.subplots(figsize = (8,8))
ap.plots.target_image(fig, ax, target)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_5_0.png" src="_images/CustomModels_5_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>my_model = My_Sersic( # notice we are now using the custom class
    name = &quot;wow I made a model&quot;,
    target = target, # now the model knows what its trying to match
    parameters = {&quot;my_n&quot;: 1., &quot;my_Re&quot;: 50, &quot;my_Ie&quot;: 1.}, # note we have to give initial values for our new parameters. We&#39;ll see what can be done for this later
)

# We gave it parameters for our new variables, but initialize will get starting values for everything else
my_model.initialize()

# The starting point for this model is not very good, lets see what the optimizer can do!
fig, ax = plt.subplots(1, 2, figsize = (16,7))
ap.plots.model_image(fig, ax[0], my_model)
ap.plots.residual_image(fig, ax[1], my_model)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_6_0.png" src="_images/CustomModels_6_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>result = ap.fit.LM(my_model, verbose = 1).fit()
print(result.message)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Chi^2/DoF: 7.139681784473457, L: 1.0
Chi^2/DoF: 5.201620648477445, L: 0.3333333333333333
Chi^2/DoF: 4.706320412054598, L: 0.5555555555555555
Chi^2/DoF: 4.394658799002307, L: 0.061728395061728385
Chi^2/DoF: 4.332028451828559, L: 0.020576131687242795
Chi^2/DoF: 4.313772724632986, L: 0.006858710562414265
Chi^2/DoF: 4.3128768107304785, L: 9.408382115794602e-06
Chi^2/DoF: 4.312869938525578, L: 1.2905873958565983e-08
Final Chi^2/DoF: 4.312869621549638, L: 1.2905873958565983e-08. Converged: success
success
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(1, 2, figsize = (16,7))
ap.plots.model_image(fig, ax[0], my_model)
ap.plots.residual_image(fig, ax[1], my_model)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_8_0.png" src="_images/CustomModels_8_0.png" />
</div>
</div>
<p>Success! Our “custom” sersic model behaves exactly as expected. While going through the tutorial so far there may have been a few things that stood out to you. Lets discuss them now:</p>
<ul class="simple">
<li><p>What was “sample_image” in the radial_model function? This is an object for the image that we are currently sampling. You shouldn’t need to do anything with it except get the pixelscale.</p></li>
<li><p>what else is in “ap.utils”? Lots of stuff used in the background by AstroPhot. For now the organization of these is not very good and sometimes changes, so you may wish to just make your own functions for the time being.</p></li>
<li><p>Why the weird way to access the parameters? The self[“variable”].value format was settled on for simplicity and generality. it’s not perfect, but it works.</p></li>
<li><p>Why is “sample_image.pixel_area” in the sersic evaluation? it is important for AstroPhot to know the size of the pixels it is evaluating, multiplying by this value will normalize the flux evaluation regardless of the pixel sizes.</p></li>
<li><p>When making the model, why did we have to provide values for the parameters? Every model can define an “initialize” function which sets the values for its parameters. Since we didn’t add that function to our custom class, it doesn’t know how to set those variables. All the other variables can be auto-initialized though.</p></li>
</ul>
</section>
<section id="Adding-an-initialize-method">
<h2>Adding an initialize method<a class="headerlink" href="#Adding-an-initialize-method" title="Link to this heading"></a></h2>
<p>Here we’ll add an initialize method. Though for simplicity we wont make it very clever. It will be up to you to figure out the best way to start your parameters. The initial values can have a huge impact on how well the model converges to the solution, so don’t underestimate the gains that can be made by thinking a bit about how to do this right. The default AstroPhot methods have reasonably robust intiializers, but still nothing beats trial and error by eye to get started.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class My_Super_Sersic(My_Sersic): # note we&#39;re inheriting everything from the My_Sersic model since its not making any new parameters
    model_type = &quot;super awesome sersic model&quot; # you can make the name anything you like, but the one above follows the normal convention

    def initialize(self,target = None, parameters = None):
        if target is None: # good to just use the model target if none given
            target = self.target
        if parameters is None:
            parameters = self.parameters
        super().initialize(target=target, parameters=parameters) # typically you want all the lower level parameters determined first

        target_area = target[self.window] # this gets the part of the image that the user actually wants us to analyze

        if self[&quot;my_n&quot;].value is None: # only do anything if the user didn&#39;t provide a value
            with ap.param.Param_Unlock(parameters[&quot;my_n&quot;]):
                parameters[&quot;my_n&quot;].value = 2. # make an initial value for my_n. Override locked since this is the beginning
                parameters[&quot;my_n&quot;].uncertainty = 0.1 # make sure there is a starting point for the uncertainty too

        if self[&quot;my_Re&quot;].value is None: # same as my_n, though in general you should try to do something smart to get a good starting point
            with ap.param.Param_Unlock(parameters[&quot;my_Re&quot;]):
                parameters[&quot;my_Re&quot;].value = 20.
                parameters[&quot;my_Re&quot;].uncertainty = 0.1

        if self[&quot;my_Ie&quot;].value is None: # lets try to be a bit clever here
            small_window = self.window.copy().crop_pixel((250,)) # This creates a window much smaller, but still centered on the same point
            with ap.param.Param_Unlock(parameters[&quot;my_Ie&quot;]):
                parameters[&quot;my_Ie&quot;].value = torch.median(target_area[small_window].data)/target_area.pixel_area # this will be an average in the window, should at least get us within an order of magnitude
                parameters[&quot;my_Ie&quot;].uncertainty = 0.1
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>my_super_model = My_Super_Sersic( # notice we switched the custom class
    name = &quot;goodness I made another one&quot;,
    target = target,
) # no longer need to provide initial values!

my_super_model.initialize()

# The starting point for this model is still not very good, lets see what the optimizer can do!
fig, ax = plt.subplots(1, 2, figsize = (16,7))
ap.plots.model_image(fig, ax[0], my_super_model)
ap.plots.residual_image(fig, ax[1], my_super_model)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_12_0.png" src="_images/CustomModels_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># We made a &quot;good&quot; intializer so this should be faster to optimize
result = ap.fit.LM(my_super_model, verbose = 1).fit()
print(result.message)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Chi^2/DoF: 4.571514325810945, L: 1.0
Chi^2/DoF: 4.338977656268726, L: 0.1111111111111111
Chi^2/DoF: 4.318142901390469, L: 0.037037037037037035
Chi^2/DoF: 4.31617140561215, L: 0.012345679012345678
Chi^2/DoF: 4.31290855297147, L: 1.693508780843029e-05
Chi^2/DoF: 4.3128716855736515, L: 2.323057312541878e-08
Final Chi^2/DoF: 4.312869679473028, L: 2.323057312541878e-08. Converged: success
success
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(1, 2, figsize = (16,7))
ap.plots.model_image(fig, ax[0], my_super_model)
ap.plots.residual_image(fig, ax[1], my_super_model)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_14_0.png" src="_images/CustomModels_14_0.png" />
</div>
</div>
<p>Success! That covers the basics of making your own models. There’s an infinite amount of possibility here so you will likely need to hunt through the AstroPhot code to find answers to more nuanced questions (or contact Connor), but hopefully this tutorial gave you a flavour of what to expect.</p>
<section id="Models-from-scratch">
<h3>Models from scratch<a class="headerlink" href="#Models-from-scratch" title="Link to this heading"></a></h3>
<p>By inheriting from <code class="docutils literal notranslate"><span class="pre">Galaxy_Model</span></code> we got to start with some methods already available. In this section we will see how to create a model essentially from scratch by inheriting from the <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> object. Below is an example model which uses a <span class="math notranslate nohighlight">\(\frac{I_0}{R}\)</span> model, this is a weird model but it will work. To demonstrate the basics for a <code class="docutils literal notranslate"><span class="pre">Component_Model</span></code> is actually simpler than a <code class="docutils literal notranslate"><span class="pre">Galaxy_Model</span></code> we really only need the <code class="docutils literal notranslate"><span class="pre">evaluate_model</span></code> function, it’s what you do with that
function where the complexity arises.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class My_InvR(ap.models.Component_Model):
    model_type = &quot;InvR model&quot;

    parameter_specs = {
        &quot;my_Rs&quot;: {&quot;limits&quot;: (0,None)}, # This will be the scale length
        &quot;my_I0&quot;: {}, # This will be the central brightness
    }
    _parameter_order = ap.models.Component_Model._parameter_order + (&quot;my_Rs&quot;, &quot;my_I0&quot;) # we have to tell AstroPhot what order to access these parameters, this is used in several underlying methods

    epsilon = 1e-4 # this can be set with model.epsilon, but will not be fit during optimization
    def evaluate_model(self, X = None, Y = None, image = None, parameters = None):
        if X is None or Y is None:
            Coords = image.get_coordinate_meshgrid()
            X, Y = Coords - parameters[&quot;center&quot;].value[...,None,None]
        return parameters[&quot;my_I0&quot;].value * image.pixel_area / torch.sqrt(X**2 + Y**2 + self.epsilon)
</pre></div>
</div>
</div>
<p>See now that we must define a <code class="docutils literal notranslate"><span class="pre">evaluate_model</span></code> method. This takes coordinates, an image object, and parameters and returns the model evaluated at the coordinates. No need to worry about integrating the model within a pixel, this will be handled internally, just evaluate the model at the center of each pixel. For most situations this is made easier with the <code class="docutils literal notranslate"><span class="pre">get_coordinate_meshgrid_torch</span></code> method that all AstroPhot <code class="docutils literal notranslate"><span class="pre">Target_Image</span></code> objects have. We also add a new value <code class="docutils literal notranslate"><span class="pre">epsilon</span></code> which is a
core radius in arcsec. This parameter will not be fit, it is set as part of the model creation. You can now also provide epsilon when creating the model, or do nothing and the default value will be used.</p>
<p>From here you have complete freedom, it need only provide a value for each pixel in the given image. Just make sure that it accounts for pixel size (proportional to pixelscale^2). Also make sure to use only pytorch functions, since that way it is possible to run on GPU and propogate derivatives.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>simpletarget = ap.image.Target_Image(data = np.zeros([100,100]), pixelscale = 1)
newmodel = My_InvR(name = &quot;newmodel&quot;, epsilon = 1, parameters = {&quot;center&quot;: [50,50], &quot;my_Rs&quot;: 10, &quot;my_I0&quot;: 1.}, target = simpletarget)

fig, ax = plt.subplots(1, 1, figsize = (8,7))
ap.plots.model_image(fig, ax, newmodel)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CustomModels_19_0.png" src="_images/CustomModels_19_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="JointModels.html" class="btn btn-neutral float-left" title="Joint Modelling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="AdvancedPSFModels.html" class="btn btn-neutral float-right" title="Advanced PSF modeling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Connor Stone.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>